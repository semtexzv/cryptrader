apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Service
  metadata:
    name: ingest
    labels: { app: trader}
  spec:
    selector: { layer: ingest }
    ports:
      - name: ingest
        port: 42042
        targetPort: 42042

      - name: eval
        port: 42044
        targetPort: 42044

      - name: trade
        port: 42045
        targetPort: 42045


- kind: Deployment
  apiVersion: apps/v1
  metadata:
    name: ingest
    labels: { app: trader }
  spec:
    replicas: 1
    selector: { matchLabels: { app: trader, layer: ingest }}
    template:
      metadata:
        labels: { app: trader, layer: ingest }
      spec:
        containers:
        - name: app
          image: ${APP_IMAGE}
          imagePullPolicy: Always
          command: ["/app", "ingest"]
          env: [{name: "RUST_LOG", value: ${RUST_LOG}}]
          resources:
            requests:
              cpu: 50m

        - name: eval-balancer
          image: ${APP_IMAGE}
          imagePullPolicy: Always
          command: ["/app", "eval-balancer"]
          env: [{name: "RUST_LOG", value: ${RUST_LOG} }]
          resources:
            requests:
              cpu: 10m

        - name: trader
          image: ${APP_IMAGE}
          imagePullPolicy: Always
          command: ["/app", "trader"]
          env: [{name: "RUST_LOG", value: ${RUST_LOG} }]
          resources:
            requests:
              cpu: 10m
